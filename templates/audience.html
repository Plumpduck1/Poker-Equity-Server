<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Poker Equity ‚Äì Audience</title>

<style>
:root {
    --bg: #0b0b0b;
    --panel: #151515;
    --border: #333;
    --text: #eaeaea;
    --muted: #999;
    --accent: #3fa9f5;
    --safe: #2ecc71;
}

/* ---------- BASE ---------- */

body {
    margin: 0;
    padding: 16px;
    font-family: system-ui, monospace;
    background: var(--bg);
    color: var(--text);
    display: flex;
    justify-content: center;
}

.page {
    width: 100%;
    max-width: 1100px;
}

h1 {
    text-align: center;
    margin-bottom: 16px;
    font-weight: 600;
}

.container {
    display: grid;
    grid-template-columns: 1.3fr 1fr 1.6fr;
    gap: 16px;
}

.panel {
    background: var(--panel);
    border: 1px solid var(--border);
    padding: 12px;
}

.panel h3 {
    margin: 0 0 10px 0;
    text-align: center;
    color: var(--accent);
}

/* ---------- PLAYERS ---------- */

.player-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.player-pos {
    font-size: 12px;
    color: var(--muted);
    margin-right: 6px;
}

.cards img {
    width: 34px;
    margin-left: 4px;
}

/* ---------- BOARD ---------- */

.board {
    display: flex;
    justify-content: center;
    min-height: 48px;
}

.board img {
    width: 44px;
    margin-right: 4px;
}

/* ---------- EQUITIES ---------- */

/* FULL: name | bar | % | hand */
.eq-row.full {
    display: grid;
    grid-template-columns: 90px minmax(120px,1fr) 56px 180px;
    gap: 10px;
    align-items: center;
    margin-bottom: 8px;
}

/* PROTECTED: name | BIG bar | % */
.eq-row.protected {
    display: grid;
    grid-template-columns: 90px minmax(220px,1fr) 56px;
    gap: 10px;
    align-items: center;
    margin-bottom: 8px;
}

.eq-row.leader {
    background: rgba(63,169,245,0.12);
}

.eq-name {
    font-weight: 600;
    white-space: nowrap;
}

.eq-bar-bg {
    height: 10px;
    background: #222;
    border-radius: 6px;
    overflow: hidden;
}

.eq-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #3fa9f5, #7cc7ff);
    transition: width 0.4s ease;
}

.eq-pct {
    text-align: right;
    font-variant-numeric: tabular-nums;
}

.eq-hand {
    font-size: 11px;
    color: var(--muted);
    white-space: nowrap;
}

/* ---------- SAFE MODE ---------- */

.safe-badge {
    margin-top: 8px;
    padding: 6px;
    border: 1px solid var(--safe);
    color: var(--safe);
    font-size: 11px;
    text-align: center;
    border-radius: 4px;
}

.muted {
    color: var(--muted);
    font-style: italic;
}

/* ---------- MOBILE ---------- */

@media (max-width: 768px) {
    body { padding: 8px; }
    h1 { font-size: 16px; margin-bottom: 8px; }

    .container {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .panel { padding: 8px; }
    .panel h3 { font-size: 13px; }

    .player-row { font-size: 13px; }
    .player-pos { font-size: 11px; }

    .cards img { width: 26px; }
    .board img { width: 34px; }

    .eq-row.full {
        grid-template-columns: 70px 1fr 44px 120px;
    }

    .eq-row.protected {
        grid-template-columns: 70px 1fr 44px;
    }

    .eq-bar-bg { height: 8px; }
    .eq-hand { font-size: 10px; }
}
</style>
</head>

<body>
<div class="page">

<h1>Live Poker Equities</h1>

<div class="container">

<!-- PLAYERS -->
<div class="panel" id="players-panel">
    <h3>Players</h3>
    <div class="muted">Waiting for host‚Ä¶</div>
</div>

<!-- BOARD -->
<div class="panel">
    <h3>Board</h3>
    <div class="board" id="board"></div>
</div>

<!-- EQUITIES -->
<div class="panel">
    <h3>Winning Chances</h3>
    <div id="equity-panel"></div>
    <div id="safe-info"></div>
</div>

</div>

<div class="muted" style="text-align:center; margin-top:10px;">
    Estimated probabilities ‚Ä¢ Spectator display
</div>

</div>

<script>
let lastVersion = -1;
let renderedBoardCount = 0;

/* ================= POSITION LOGIC (2‚Äì10 players) ================= */
function derivePositions(players, btnIndex) {
    const n = players.length;
    const map = {};

    if (n === 0) return map;

    map[players[btnIndex]] = "BTN";

    if (n >= 2)
        map[players[(btnIndex + 1) % n]] = "SB";

    if (n >= 3)
        map[players[(btnIndex + 2) % n]] = "BB";

    let utgIndex = 0;
    for (let i = 3; i < n; i++) {
        const label = utgIndex === 0 ? "UTG" : `UTG+${utgIndex}`;
        map[players[(btnIndex + i) % n]] = label;
        utgIndex++;
    }

    return map;
}

async function updateGame() {
    const res = await fetch("/game_state");
    const data = await res.json();

    if (!data || !data.players) {
        document.getElementById("players-panel").innerHTML =
            "<h3>Players</h3><div class='muted'>Waiting for host to start game‚Ä¶</div>";
        document.getElementById("board").innerHTML = "";
        document.getElementById("equity-panel").innerHTML =
            "<div class='muted'>No hand in progress</div>";
        document.getElementById("safe-info").innerHTML = "";
        return;
    }

    if (data.version === lastVersion) return;
    lastVersion = data.version;

    /* ---------- PLAYERS ---------- */
    const playersPanel = document.getElementById("players-panel");
    playersPanel.innerHTML = "<h3>Players</h3>";

    const positions = derivePositions(data.players, data.button_index);

    data.players.forEach(p => {
        const row = document.createElement("div");
        row.className = "player-row";

        row.innerHTML = `
            <div>
                <span class="player-pos">${positions[p] || ""}</span>${p}
            </div>
        `;

        if (data.info_mode === "FULL" && data.hands?.[p]) {
            const cards = document.createElement("div");
            cards.className = "cards";
            data.hands[p].forEach(c => {
                const img = document.createElement("img");
                img.src = "/static/cards/" + c + ".png";
                cards.appendChild(img);
            });
            row.appendChild(cards);
        }

        playersPanel.appendChild(row);
    });

    /* ---------- BOARD ---------- */
    const boardEl = document.getElementById("board");

    if (data.board.length < renderedBoardCount) {
        boardEl.innerHTML = "";
        renderedBoardCount = 0;
    }

    data.board.slice(renderedBoardCount).forEach(c => {
        const img = document.createElement("img");
        img.src = "/static/cards/" + c + ".png";
        boardEl.appendChild(img);
    });

    renderedBoardCount = data.board.length;

    /* ---------- EQUITIES ---------- */
    const eqPanel = document.getElementById("equity-panel");
    eqPanel.innerHTML = "";

    if (data.phase === "WAITING") {
        eqPanel.innerHTML = "<div class='muted'>No hand in progress</div>";
        return;
    }

    const equities = data.display_equities || [];
    const maxEq = Math.max(...equities, 0);
    const isProtected = data.info_mode === "DELAYED_EQUITY";

    data.players.forEach((p, i) => {
        const pct = Math.round(equities[i] || 0);
        const leader = pct === Math.round(maxEq) && maxEq > 0;

        const row = document.createElement("div");
        row.className =
            (isProtected ? "eq-row protected" : "eq-row full") +
            (leader ? " leader" : "");

        row.innerHTML = isProtected
            ? `
                <div class="eq-name">${p}</div>
                <div class="eq-bar-bg">
                    <div class="eq-bar-fill" style="width:${pct}%"></div>
                </div>
                <div class="eq-pct">${pct}%</div>
              `
            : `
                <div class="eq-name">${p}</div>
                <div class="eq-bar-bg">
                    <div class="eq-bar-fill" style="width:${pct}%"></div>
                </div>
                <div class="eq-pct">${pct}%</div>
                <div class="eq-hand">${data.display_hand_ranks?.[p] || ""}</div>
              `;

        eqPanel.appendChild(row);
    });

    /* ---------- SAFE MODE INFO ---------- */
    const safeInfo = document.getElementById("safe-info");
    safeInfo.innerHTML = "";

    if (isProtected) {
        safeInfo.innerHTML = `
            <div class="safe-badge">
                üõ°Ô∏è Protected mode ‚Äî winning chances shown one round later
            </div>`;
    }
}

setInterval(updateGame, 800);
updateGame();
</script>

</body>
</html>
