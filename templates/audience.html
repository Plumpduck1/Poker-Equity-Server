<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">

<!-- CRITICAL FOR MOBILE -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

<title>Poker Equity – Audience</title>

<style>
:root {
    --bg: #0b0b0b;
    --panel: #151515;
    --border: #333;
    --text: #eaeaea;
    --muted: #999;
    --accent: #3fa9f5;
}

* {
    box-sizing: border-box;
}

/* ================= BODY ================= */

body {
    margin: 0;
    padding: 16px;
    font-family: system-ui, monospace;
    background: var(--bg);
    color: var(--text);
    display: flex;
    justify-content: center;
}

/* ================= PAGE WRAPPER ================= */

.page {
    width: 100%;
    max-width: 1100px;   /* prevents stretching on large screens */
}

/* ================= HEADER ================= */

h1 {
    text-align: center;
    margin: 0 0 16px 0;
    font-weight: 600;
}

/* ================= LAYOUT ================= */

.container {
    display: grid;
    grid-template-columns: 1.3fr 1fr 1.4fr;
    gap: 16px;
}

/* ================= PANELS ================= */

.panel {
    background: var(--panel);
    border: 1px solid var(--border);
    padding: 12px;
    width: 100%;
}

.panel h3 {
    margin: 0 0 10px 0;
    text-align: center;
    font-weight: 600;
    color: var(--accent);
}

/* ================= PLAYERS ================= */

.player-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.player-left {
    display: flex;
    align-items: center;
    gap: 6px;
}

.player-pos {
    font-size: 12px;
    color: var(--muted);
}

.player-name {
    font-weight: 600;
}

.cards img {
    width: 40px;
    margin-left: 2px;
}

/* ================= BOARD ================= */

.board {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 48px;
}

.board img {
    width: 44px;
    margin-right: 4px;
}

/* ================= EQUITIES ================= */

.eq-row {
    display: grid;
    grid-template-columns: 90px 1fr 150px;
    gap: 8px;
    align-items: center;
    margin-bottom: 8px;
    padding: 4px;
}

.eq-row.leader {
    background: rgba(63,169,245,0.12);
}

.eq-name {
    font-weight: 600;
    white-space: nowrap;
}

.eq-bar-bg {
    height: 10px;
    background: #222;
    border-radius: 6px;
    overflow: hidden;
}

.eq-bar-fill {
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, #3fa9f5, #7cc7ff);
    transition: width 0.5s ease;
}

.eq-val {
    text-align: right;
    font-variant-numeric: tabular-nums;
    white-space: nowrap;
}

.eq-hand {
    font-size: 12px;
    color: var(--muted);
    margin-left: 6px;
}

/* ================= PULSE ================= */

@keyframes pulse {
    0% { box-shadow: 0 0 0 rgba(63,169,245,0); }
    50% { box-shadow: 0 0 8px rgba(63,169,245,0.6); }
    100% { box-shadow: 0 0 0 rgba(63,169,245,0); }
}

.eq-bar-fill.pulse {
    animation: pulse 0.6s ease-out;
}

/* ================= PLACEHOLDER ================= */

.placeholder {
    text-align: center;
    color: var(--muted);
    font-style: italic;
}

/* ================= FOOTER ================= */

.footer {
    margin-top: 12px;
    text-align: center;
    font-size: 12px;
    color: var(--muted);
}

/* ================= MOBILE ================= */

@media (max-width: 768px) {

    body {
        padding: 10px;
    }

    .container {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .cards img {
        width: 34px;
    }

    .board img {
        width: 36px;
    }

    .eq-row {
        grid-template-columns: 80px 1fr 120px;
    }

    h1 {
        font-size: 18px;
    }
}
</style>
</head>

<body>

<div class="page">

<h1>Live Poker Equities</h1>

<div class="container">

    <!-- PLAYERS -->
    <div class="panel" id="players-panel">
        <h3>Players</h3>
        <div class="placeholder">Waiting for table…</div>
    </div>

    <!-- BOARD -->
    <div class="panel" id="board-panel">
        <h3>Board</h3>
        <div class="board placeholder">—</div>
    </div>

    <!-- EQUITIES -->
    <div class="panel" id="equity-panel">
        <h3>Equities</h3>
        <div class="placeholder">No hand in progress</div>
    </div>

</div>

<div class="footer">
    Cards are scanned once • Display delayed • Spectator view
</div>

</div>

<script>
let lastEquities = {};

function derivePositions(players, btn) {
    const labels = ["BTN","SB","BB","UTG","HJ","CO"];
    const map = {};
    for (let i = 0; i < 6; i++) {
        map[players[(btn + i) % 6]] = labels[i];
    }
    return map;
}

async function updateGame() {
    const res = await fetch("/game_state");
    const data = await res.json();
    if (!data.players) return;

    const positions = derivePositions(data.players, data.button_index);

    /* PLAYERS */
    const playersPanel = document.getElementById("players-panel");
    playersPanel.innerHTML = "<h3>Players</h3>";

    data.players.forEach(p => {
        const row = document.createElement("div");
        row.className = "player-row";
        row.innerHTML = `
            <div class="player-left">
                <span class="player-pos">${positions[p]}</span>
                <span class="player-name">${p}</span>
            </div>
        `;

        const cards = document.createElement("span");
        cards.className = "cards";

        if (data.hands && data.hands[p]) {
            data.hands[p].forEach(c => {
                const img = document.createElement("img");
                img.src = "/static/cards/" + c + ".png";
                cards.appendChild(img);
            });
        }

        row.appendChild(cards);
        playersPanel.appendChild(row);
    });

    /* BOARD */
    const boardPanel = document.getElementById("board-panel");
    boardPanel.innerHTML = "<h3>Board</h3>";
    const board = document.createElement("div");
    board.className = "board";

    if (data.board?.length) {
        data.board.forEach(c => {
            const img = document.createElement("img");
            img.src = "/static/cards/" + c + ".png";
            board.appendChild(img);
        });
    } else {
        board.classList.add("placeholder");
        board.textContent = "—";
    }

    boardPanel.appendChild(board);

    /* EQUITIES */
    const eqPanel = document.getElementById("equity-panel");
    eqPanel.innerHTML = "<h3>Equities</h3>";

    if (data.phase !== "WAITING") {
        const maxEq = Math.max(...data.equities);

        data.players.forEach((p, i) => {
            const pct = Math.round(data.equities[i]);
            const leader = data.equities[i] === maxEq && maxEq > 0;

            const row = document.createElement("div");
            row.className = "eq-row" + (leader ? " leader" : "");

            row.innerHTML = `
                <div class="eq-name">${p}</div>
                <div class="eq-bar-bg"><div class="eq-bar-fill"></div></div>
                <div class="eq-val">${pct}% <span class="eq-hand">${data.hand_ranks[p] || ""}</span></div>
            `;

            const fill = row.querySelector(".eq-bar-fill");
            fill.style.width = pct + "%";

            if (lastEquities[p] !== undefined && lastEquities[p] !== pct) {
                fill.classList.add("pulse");
            }

            lastEquities[p] = pct;
            eqPanel.appendChild(row);
        });

        if (data.tie_probability > 0) {
            const t = Math.round(data.tie_probability);
            const row = document.createElement("div");
            row.className = "eq-row";
            row.innerHTML = `
                <div class="eq-name">Split Pot</div>
                <div class="eq-bar-bg"><div class="eq-bar-fill" style="width:${t}%"></div></div>
                <div class="eq-val">${t}%</div>
            `;
            eqPanel.appendChild(row);
        }
    } else {
        eqPanel.innerHTML += `<div class="placeholder">Waiting for hand…</div>`;
        lastEquities = {};
    }
}

setInterval(updateGame, 1500);
updateGame();
</script>

</body>
</html>
